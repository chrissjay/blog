---
title: "JVM之垃圾回收"
catalog: true
date: 2019-05-24 11:20:12
subtitle: "This is about JVM."
header-img: "Demo.png"
tags:
- JVM
- 垃圾回收
catagories:
- JVM
---

# JVM之垃圾回收

## 1.判断是否需要回收

**可达分析性算法，引用计数算法**

### 1.可达分析性算法(mark and sweep)

1. mark，从 root 开始进行树遍历，每个访问的对象标注为「使用中」
2. sweep，扫描整个内存区域，对于标注为「使用中」的对象去掉该标志，对于没有该标注的对象直接回收掉

### 2.引用计数算法

引用计数类 GC 会记录每个对象的引用次数，当引用次数为0时，就会被回收

### 3.引用类型

- **强引用——GC无论如何都不会回收，即使抛出OOM异常**

  在程序代码中普遍存在的，类似 `Object obj = new Object()` 这类引用，只要强引用还存在，垃圾收集器永远不会回收掉被引用的对象。

- **软引用——只有当JVM内存不足时才会被回收**

  用来描述一些还有用但并非必须的对象。对于软引用关联着的对象，在系统将要发生内存溢出异常之前，将会把这些对象列进回收范围之中进行第二次回收。如果这次回收后还没有足够的内存，才会抛出内存溢出异常。

- **弱引用——只要GC,就会立马回收，不管内存是否充足**

  也是用来描述非必需对象的，但是它的强度比软引用更弱一些，被弱引用关联的对象只能生存到下一次垃圾收集发生之前。当垃圾收集器工作时，无论当前内存是否足够，都会回收掉只被弱引用关联的对象。

- **虚引用——可以忽略不计，JVM完全不会在乎虚引用。它唯一的作用就是做一些跟踪记录，辅助finalize函数的使用**

  也叫幽灵引用或幻影引用（名字真会取，很魔幻的样子），是最弱的一种引用关系。一个对象是否有虚引用的存在，完全不会对其生存时间构成影响，也无法通过虚引用来取得一个对象实例。它的作用是能在这个对象被收集器回收时收到一个系统通知。

## 2.回收算法

**标记-清除算法，标记-整理算法，标记-复制算法，分代收集算法**

### 1.堆内存空间

![2018-02-02-17-24-16](/Users/chriswu/Desktop/Java%E5%BC%80%E5%8F%91%E6%8A%80%E6%9C%AF%E6%A0%88/pic/2018-02-02-17-24-16.png)

### 2.标记-整理算法

![3789193-27c645c7700f687b](/Users/chriswu/Desktop/Java%E5%BC%80%E5%8F%91%E6%8A%80%E6%9C%AF%E6%A0%88/pic/3789193-27c645c7700f687b.png)

### 3.标记-复制算法

![3789193-f3564647800ab93c](/Users/chriswu/Desktop/Java%E5%BC%80%E5%8F%91%E6%8A%80%E6%9C%AF%E6%A0%88/pic/3789193-f3564647800ab93c.png)

## 3.回收器

**Serial（串行），Parallel（并行） GC，CMS，G1等**

##### 1.CMS

Concurrent Mark and Sweep ，对年轻代采用并行 STW方式的标记-复制，对老年代采用标记清除

##### 2.G1

G1垃圾回收器适用于堆内存很大的情况，他将堆内存分割成不同的区域，并且并发的对其进行垃圾回收。G1也可以在回收内存之后对剩余的堆内存空间进行压缩。并发扫描标记垃圾回收器在STW情况下压缩内存。G1垃圾回收会优先选择第一块垃圾最多的区域。

## 4.System.gc()和finalize()

调用System.gc()也仅仅是一个请求(建议)

finalize()的主要用途是释放一些其他做法开辟的内存空间

## 5.减少GC开销的措施

1. 不要显式调用System.gc()
2. 尽量使用StringBuffer,而不用String来累加字符串
3. 能用基本类型如Int,Long,就不用Integer,Long对象
4. 尽量减少临时对象的使用
5. 尽量少用静态对象变量

## 6.Java内存泄露

```java
Static Vector v = new Vector();
for (int i = 1; i<100; i++)
{
  Object o = new Object();
  v.add(o);
  o = null;
}
```

